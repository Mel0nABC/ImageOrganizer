<!DOCTYPE html>
<html lang="es" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta Content-Type="text/html" charset="UTF-8">
    <title>DashBoard</title>
    <link type="text/css" rel="stylesheet" href="/css/galeria.css">
    <!-- <script type="text/javascript" src="../static/js/test.js"></script> -->
    <!-- <script type="text/js" src="../static/js/galeriaFunctions.js"></script> -->
    <script>


        window.addEventListener("load", (event) => {
            loadSeccionCarpetasImagenes();
            setTimeout(() => {
                cargar();
            }, 1000);

            document.getElementById("btnMkDir").addEventListener("click", event => {
                console.log("PIUUUMM")

            })
        });

        // CERRAR CAJA AVISO ELIMINACIÓN DIRECTORIO O ARCHIVO
        function cerrarCajaDel() {
            respMsg.innerHTML = "";
        }

        // PARA GESTIONAR LOS DIRECTORIOS CONFIGURADOS.
        function editPathFolders() {
            document.getElementById("nav").innerHTML += "<div id='editPathFolders-container'></div>";
            editpathcontainer = document.getElementById("editPathFolders-container");
            fetch(`/openConfigDirectory`)
                .then(res => res.text())
                .then(response => {
                    jsonPath = JSON.parse(response);

                    let tbodyTr = "";
                    for (i = 0; i < jsonPath.configDirs.length; i++) {
                        tbodyTr += `<tr id="${jsonPath.configDirs[i]}">
                                    <td>${jsonPath.configDirs[i]}</td>
                                    <td><button name="btnDeletePath" value="${jsonPath.configDirs[i]}">ELIMINAR</button></td>
                                    </tr>`;
                    }
                    let html = `<div id="editPathFolders">
                                        <h1>Editar directorios configurado</h1>
                                            <div class="menu-container">
                                                <button id="addNewPathBtn" class="boton">Agregar nueva ruta</button>
                                                <button id="cancelNewPathBtn" class="boton">CERRAR</button>
                                            </div>
                                        <section>
                                            <table>
                                                <thead>
                                                    <th>RUTA</th>
                                                    <th>ACCION</th>
                                                </thead>

                                                <tbody>
                                                        ${tbodyTr}
                                                </tbody>
                                            </table>
                                        </section>
                                        <div id="newPathContainer"></div>
                        </div>`;
                    editpathcontainer.innerHTML = html;
                    cargarEditarDirectorios();
                })
        }

        function showNewDirectory() {
            const addNewPath = document.getElementById("addNewPathBtn");
            addNewPath.addEventListener("click", event => {
                fetch("/editDirectory?path=/")
                    .then(res => res.text())
                    .then(response => {
                        let json = JSON.parse(response)
                        let dirList = "";
                        for (i = 0; i < json.dirList.length; i++) {
                            dirList += `<li name="actionDir" class="pointer">${json.dirList[i]}</li>`
                        }
                        document.getElementById("newPathContainer").innerHTML = `
                            <div id="newPathDiv" class="newPathDiv">
                                <div class="newPathNav">
                                    <button id="closeNewPathDiv">CANCELAR</button>
                                    <button id="confirmNewPath">ACEPTAR</button>
                                </div>
                                <div>
                                    <input id="absolutPath" type="text" value=""/>
                                </div>
                                <div class="newPathContainer">
                                    <div class="home-directory">
                                        <ul class="dir-list">
                                            ${dirList}
                                        </ul>
                                    </div>
                                    <div class="file-directory">
                                        <ul id="contentPath" class="dir-list">
                                        </ul>
                                    </div>
                                </div>
                                </div>`;

                        document.getElementById("confirmNewPath").addEventListener("click", event => {
                            let newFolderPath = document.getElementById("absolutPath").value;
                            fetch(`/confirmNewPath?newFolderParh=${newFolderPath}`)
                                .then(res => res.text())
                                .then(response => {
                                    if (response === "true") {
                                        alert("Directorio añadido satisfactoriamente.")
                                        editPathFolders();
                                    } else {
                                        alert("No se pudo añadir el directorio seleccionado.")
                                    }
                                })
                        })
                        const actionDirBtn = document.getElementsByName("actionDir");

                        for (i = 0; i < actionDirBtn.length; i++) {
                            actionDirBtn[i].addEventListener("click", event => {
                                actionDirFunc(event);
                            })
                        }

                        const closeNewPathDivBtn = document.getElementById("closeNewPathDiv");

                        closeNewPathDivBtn.addEventListener("click", event => {
                            document.getElementById("newPathDiv").remove();
                        })
                    })
            })
        }

        function cargarEditarDirectorios() {
            showNewDirectory();
            const btnDeletePath = document.getElementsByName("btnDeletePath");

            for (i = 0; i < btnDeletePath.length; i++) {
                btnDeletePath[i].addEventListener("click", event => {
                    let path = event.target.value;
                    fetch(`/delDirectory?path=${path}`)
                        .then(res => res.text())
                        .then(response => {

                            if (response === "true") {
                                document.getElementById(path).remove();
                            }
                        })
                })
            }
            document.getElementById("cancelNewPathBtn").addEventListener("click", event => {
                document.getElementById("editPathFolders-container").remove();
                document.getElementById("btnPathFolder").addEventListener("click", event => {
                    editPathFolders();
                })
            })
        }

        function actionDirFunc(event) {
            let path = event.target.innerHTML;
            fetch(`/editDirectory?path=${path}`)
                .then(res => res.text())
                .then(response => {
                    let json = JSON.parse(response)
                    let contentDir = "";
                    let contentFiles = "";

                    contentDir += `<li name="actionDir" class="pointer">${json.pathFirst}</li>`
                    for (i = 0; i < json.dirList.length; i++) {
                        contentDir += `<li name="actionDir" class="pointer">${json.dirList[i]}</li>`
                    }
                    for (i = 0; i < json.fileList.length; i++) {
                        contentFiles += `<li name="actionDir" class="pointer">${json.fileList[i]}</li>`
                    }
                    document.getElementById("contentPath").innerHTML = contentDir + contentFiles;
                    const actionDirBtn = document.getElementsByName("actionDir");
                    document.getElementById("absolutPath").value = path;
                    for (i = 0; i < actionDirBtn.length; i++) {
                        actionDirBtn[i].addEventListener("click", event => {
                            actionDirFunc(event);
                        })
                    }
                })
        }

        let nombre;
        let nombre2;
        let inputNewName;

        function cargar() {
            console.log("SECCION CARGAR()")

            btnRenameDirImg = document.getElementsByName("btnRenameDirImg");
            delDirImg = document.getElementsByName("delDirImg");
            // PARA RENOMBRAR DIRECTRORIOS E IMÁGENES

            console.log(btnRenameDirImg.length)
            console.log(delDirImg.length)
            for (i = 0; i < btnRenameDirImg.length; i++) {
                console.log("tete")
                btnRenameDirImg[i].addEventListener("click", (event) => {
                    let boton = event.target;
                    inputNewName = document.getElementById("newName" + boton.value);
                    if (boton.innerHTML == "Aceptar") {
                        nombre2 = inputNewName.value;
                        if (nombre !== nombre2) {
                            fetch(`/rename?name=${nombre}&newName=${nombre2}`)
                                .then(res => res.text())
                                .then(response => {
                                    let json = JSON.parse(response);
                                    if (json.response = true) {
                                        location.reload();
                                    }
                                })
                        }
                        inputNewName.type = 'hidden';
                        boton.innerHTML = "Renombrar";
                    } else {
                        nombre = inputNewName.value;
                        inputNewName.type = 'visible';
                        boton.innerHTML = "Aceptar";
                    }
                });

            }


            // PARA ELIMINAR DIRECTORIOS E IMÁGENES
            let respMsg = null;
            for (i = 0; i < delDirImg.length; i++) {
                document.getElementsByName("delDirImg")[i].addEventListener("click", event => {

                    let confirma = confirm(`¿Confirma que desea eliminar el elemento?"${event.target.id}"
                                            Aceptar o Cancelar.`);
                    if (confirma) {
                        fetch("/delImgOrDirectory?path=" + event.target.value)
                            .then(res => res.text())
                            .then(response => {
                                let json = JSON.parse(response);
                                respMsg = document.getElementById("respMsg");
                                if (json.respuesta === "ok") {
                                    respMsg.innerHTML =
                                        `<div id="cajaDel" role="alert" style="background: rgba(138,221,45,0.5)">
                                    <p id="respuestaDel">${json.delMsg}</p>
                                    <button id="respuestaDela" onclick="cerrarCajaDel()">X</button>
                                    </div > `;
                                    document.getElementById(event.target.id).remove();
                                } else {
                                    respMsg.innerHTML =
                                        `<div id="cajaDel" role="alert" style="background: rgba(255,0,0,0.5);" >
                                    <p id="respuestaDel">${json.delMsg}</p>
                                    <button id="respuestaDela" onclick="cerrarCajaDel()">X</button>
                                    </div > `;
                                }
                            })
                    }
                });
            }
            document.getElementById("btnPathFolder").addEventListener("click", event => {
                editPathFolders(event);
            })
        }

        function loadSeccionCarpetasImagenes() {
            console.log("SECCION LOADSECCIONCARPETASIMAGENES")
            var pathname = window.location.pathname;
            fetch(`/cargaContenido?uri=${pathname}`)
                .then(res => res.text())
                .then(response => {
                    let json = JSON.parse(response)

                    document.getElementById("header-container").innerHTML = `<h1>${json.username}</h1>`

                    let verifyEmptyFolder = json.folderStatus;
                    let emptyFolder = "";
                    let dirSection = "";
                    let fileSection = "";
                    if (verifyEmptyFolder === 'empty') {
                        emptyFolder = `<h3>La carpeta está vacia.</h3>`;
                    } else {

                        for (i = 0; i < json.dirList.length; i++) {
                            dirSection += `<article id="${json.dirList[i].name}" class="dirContainer">
                                <a href="${json.dirList[i].src}"><img name="${json.dirList[i].name}" src="/images/carpeta.png"></a>
                                <p id="showName${json.dirList[i].name}">${json.dirList[i].name}</p>`

                            if (json.uriUbicacion.length > 1) {
                                dirSection +=
                                    `<div>
                                        <button id="${json.dirList[i].name}" name="delDirImg" value="${json.dirList[i].src}">Eliminar</button>
                                        <input id="newName${json.dirList[i].name}" name="newName" value="${json.dirList[i].name}" type="hidden" />
                                        <button name="btnRenameDirImg" value="${json.dirList[i].name}" type="button">Renombrar</button>
                                    </div>`;
                            }
                            dirSection += ` </article>`;

                        }

                        for (i = 0; i < json.fileList.length; i++) {
                            fileSection += `<article id="${json.fileList[i].name}" class="imgContainer" name="${json.fileList[i].name}">
                            <a attr="onclick=|getInfoImg('${json.fileList[i].name}','${json.fileList[i].src}')|"><img id="${json.fileList[i].id}"
                                    name="${json.fileList[i].name}" src="${json.fileList[i].src}"></a>
                            <p id="showName${json.fileList[i].name}">${json.fileList[i].name}</p>
                            <button id="${json.fileList[i].name}" name="delDirImg" value="${json.fileList[i].src}">Eliminar</button>
                            <input id="newName${json.fileList[i].name}" name="newName" value="${json.fileList[i].name}" type="hidden" />
                            <button name="btnRenameDirImg" value="${json.fileList[i].name}" type="button">Renombrar</button>
                            </article>`
                        }


                    }
                    let uriUbica = "";

                    for (i = 0; i < json.uriUbicacion.length; i++) {
                        uriUbica = `<a id="${json.uriUbicacion[i].uriTotal}" name="uriUbicaList" class="pointer" style="display: inline;">${json.uriUbicacion[i].carpeta}</a>`;
                        document.getElementById("rutaPath").innerHTML += uriUbica;
                    }
                    let uriUbicaList = document.getElementsByName("uriUbicaList");

                    for (i = 0; i < uriUbicaList.length; i++) {
                        uriUbicaList[i].addEventListener("click", event => {
                            window.location.pathname = event.target.id;
                        })
                    }

                    let html =
                        `<div id="seccionCarpetasImagenes-container">
                            <!-- APARTADO DE CONTENIDO DE DIRECTORIOS -->
                            ${emptyFolder}
                            ${dirSection}
                            ${fileSection}
                       </div>`;
                    document.getElementById("seccionCarpetasImagenes").innerHTML = html;
                })
        }


        // PARA OBTENER LA INFORMACIÓN DE UNA IMAGEN.
        let infoImgBox = null;

        function getInfoImg(path, urlImg) {
            const options = {
                method: 'GET'
            };
            fetch("/imgProperties?imgName=" + path, options)
                .then(res => res.text())
                .then(response => {
                    if (infoImgBox !== null) {
                        infoImgBox.remove();
                    }
                    document.getElementById("nav").innerHTML += "<div id='infoImgBox'></div>";
                    infoImgBox = document.getElementById("infoImgBox");
                    const json = JSON.parse(response);

                    infoImgBox.innerHTML += `<button onclick="cerrarBox()"" id="closeImgBox"> X</button>
            <img src="` + urlImg + `"/>
            <table id='infoImgTable'>
            <thead><th>PROPIEDAD</th><th>VALOR</th></thead >
            <tbody>
            <tr>
            <td>HEIGHT</td>
            <td>${json.height}</td>
            </tr>
            <tr>
            <td>WIDTH</td>
            <td>${json.width}</td>
            </tr>
            <tr>
            <td>TRANSPARENCIA</td>
            <td>${json.transparencia}</td>
            </tr>
            <tr>
            <td>TIPO</td>
            <td>${json.type}</td>
            </tr>
            <tr>
            <td>RUTA</td>
            <td>${json.rutaAbsoluta}</td>
            </tr>
            </tbody>
            </table>`;
                });
        }

        // CERRAR CAJA DE INFO DE IMAGEN
        function cerrarBox() {
            infoImgBox.remove();
        }
    </script>

</head>

<body id="body">




    <header id="header-container">
        <h1 th:text="${username}"></h1>
    </header>

    <nav id="nav">
        <div id="botonesNav">
            <button id="btnPathFolder">GESTIÓN CARPETAS</button>
            <form th:action="@{/logout}" method="post">
                <button type="submit">LOGOUT</button>
            </form>
            <button id="btnMkDir">NUEVA CARPETA</button>

        </div>

        <!-- <form th:action="@{/mkDir}" method="post">
            <input id="uri" name="uri" th:value="${uri}" type="hidden" />
            CREAR DIRECTORIO:
            <input id="dirName" name="dirName" type="text" formmethod="post" />
            <input type="submit" value="CREAR" />
        </form>
        <form th:action="@{/uploadImg}" method="post" enctype="multipart/form-data">
            SUBIR IMÁGENES
            <input id="imgFile" name="imgFile" type="file" value="Subir imagen" formmethod="post" accept="image/*"
                multiple />
            <input id="uri" name="uri" th:value="${uri}" type="hidden" />
            <input type="submit" value="Enviar" />
        </form> -->
        <h3 id="rutaPath" style="margin:0 0;"></h3>
    </nav>

    <section>
        <div id="respMsg"></div>
        <div id="seccionCarpetasImagenes" class="center"></div>
    </section>
    <footer>
        <p>Footer blah blah blah ....</p>
    </footer>


</body>

</html>